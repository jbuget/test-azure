<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Éditer contact</title>
    <style>
      :root { --fg:#111; --bg:#fff; --muted:#666; }
      * { box-sizing: border-box; }
      body { margin: 0; font: 14px/1.4 -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); background: var(--bg); }
      header { padding: 12px 16px; border-bottom: 1px solid #eee; display:flex; gap:8px; align-items:center; }
      header a { text-decoration:none; }
      main { max-width: 720px; margin: 0 auto; padding: 16px; }
      h1 { font-size: 18px; margin: 0 0 12px; }
      .row { display:flex; gap:8px; align-items:center; }
      .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#f9f9f9; color:#000; text-decoration:none; cursor:pointer; }
      form { display:grid; gap:8px; }
      label { display:grid; gap:4px; }
      input { padding:8px; border:1px solid #ddd; border-radius:6px; font: inherit; }
      .muted { color: var(--muted); font-size:12px; }
    </style>
  </head>
  <body>
    <header>
      <a href="/">Accueil</a>
      <span class="muted">/</span>
      <a href="/contacts">Contacts</a>
    </header>
    <main>
      <% if (notFound) { %>
        <h1>Contact introuvable</h1>
        <a class="btn" href="/contacts">Retour</a>
      <% } else { %>
        <h1>Éditer contact #<%= contact.id %></h1>
        <form id="f">
          <label>Prénom<input name="firstName" value="<%= contact.firstName || '' %>" /></label>
          <label>Nom<input name="lastName" value="<%= contact.lastName || '' %>" /></label>
          <label>Téléphone<input name="phoneNumber" value="<%= contact.phoneNumber || '' %>" /></label>
          <label>Email<input type="email" name="email" value="<%= contact.email || '' %>" /></label>
          <div>
            <label>Photo de profil</label>
            <% if (contact.photo) { %>
              <div class="row" style="gap:12px;align-items:center;">
                <img src="/media/contacts/<%= contact.id %>" alt="photo" style="width:64px;height:64px;object-fit:cover;border-radius:6px;border:1px solid #eee;" />
                <button id="delPhoto" class="btn" type="button">Supprimer la photo</button>
              </div>
            <% } %>
            <div class="row" style="gap:8px; align-items:center; margin-top:8px;">
              <input id="photo" type="file" accept="image/*" />
              <button id="uploadPhoto" class="btn" type="button">Téléverser</button>
            </div>
          </div>
          <div class="row" style="gap:12px;">
            <button class="btn" type="submit">Enregistrer</button>
            <button id="del" class="btn" type="button">Supprimer</button>
            <a class="btn" href="/contact/<%= contact.id %>">Annuler</a>
          </div>
        </form>
      <% } %>
    </main>
    <% if (!notFound) { %>
    <script>
      const form = document.querySelector('#f');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        const res = await fetch('/api/contacts/<%= contact.id %>', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
        if (res.ok) location.href='/contact/<%= contact.id %>'; else alert("Erreur lors de l'enregistrement");
      });
      document.getElementById('uploadPhoto').addEventListener('click', async ()=>{
        const input = document.getElementById('photo');
        if (!input || !input.files || !input.files[0]) { alert('Choisissez une image'); return; }
        const fd = new FormData();
        fd.append('file', input.files[0]);
        const res = await fetch('/api/contacts/<%= contact.id %>/photo', { method:'POST', body: fd });
        if (res.ok) location.reload(); else alert('Erreur lors du téléversement');
      });
      const delPhotoBtn = document.getElementById('delPhoto');
      if (delPhotoBtn) delPhotoBtn.addEventListener('click', async ()=>{
        if (!confirm('Supprimer la photo ?')) return;
        const res = await fetch('/api/contacts/<%= contact.id %>/photo', { method: 'DELETE' });
        if (res.ok) location.reload(); else alert('Erreur lors de la suppression');
      });
      document.getElementById('del').addEventListener('click', async () => {
        if (!confirm('Supprimer ce contact ?')) return;
        const res = await fetch('/api/contacts/<%= contact.id %>', { method: 'DELETE' });
        if (res.ok) {
          location.href = '/contacts';
        } else {
          alert('Erreur lors de la suppression');
        }
      });
    </script>
    <% } %>
  </body>
</html>
